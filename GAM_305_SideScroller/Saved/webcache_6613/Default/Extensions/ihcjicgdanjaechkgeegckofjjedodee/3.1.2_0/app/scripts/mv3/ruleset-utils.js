import{simpleStorageGet,simpleStorageSet}from"@/utils/storage.ts";import{chrome}from"../../../utils/polyfill.ts";import{MV3_PROTECTION_ADS,MV3_PROTECTION_MALWARE,MV3_PROTECTION_SCAMS,BROWSER_NAME}from"../app-consts";import{TARGET_BROWSER}from"../browser-const.js";import*as Sentry from"@sentry/browser";export const defaultRulesetPatterns=["mbgc.mv3.whitelist","mbgc.mv3.ads","mbgc.mv3.malware","mbgc.mv3.easylist","mbgc.mv3.easyprivacy"];export const tryInitMV3Rulesets=async()=>{const e=await getAllAvailableStaticRulesets(),t=await chrome.declarativeNetRequest.getEnabledRulesets();let s=e.filter(e=>!t.includes(e));if(console.debug("TIRM: Will try to enable rulesets: ",{notEnabledRulesets:s}),s.length>0){const{failedRulesets:e,enabledRulesets:t}=await tryUpdateEnabledRulesets(s);if(e.length>0){const t=e.map(e=>e.rulesetID),s=e.some(e=>!0===e.isBrowserError);return console.error("TIRM: Failed to enable all rulesets: ",t.join(",")),void showRulesetErrorPage(t,s)}console.log("TIRM: All rulesets enabled: ",t.join(",")),await simpleStorageSet({mv3RulesetSelection:t})}};export const tryInitMV3RulesetsWithSelectedIds=async e=>{const{failedRulesets:t,enabledRulesets:s}=await tryUpdateEnabledRulesets(e);return t.length>0&&console.error("TIMRWSI: Failed init selected rulesets: ",{failedRulesets:t,enabledRulesets:s}),await simpleStorageSet({mv3RulesetSelection:s}),{failedRulesets:t,enabledRulesets:s}};export const checkForAdditionalRuleSpace=async e=>{const t=await simpleStorageGet("mv3RulesetSelection")||[];console.log("CARS: Ruleset selection: ",t);const s=void 0===e.enableProtectionAds||e.enableProtectionAds,l=void 0===e.enableProtectionMalware||e.enableProtectionMalware;console.debug("CARS: Checking for additional rule space",{isAdsEnabled:s,isMalwareEnabled:l});const r=await chrome.declarativeNetRequest.getEnabledRulesets()||[],a=await chrome.declarativeNetRequest.getAvailableStaticRuleCount()||0,o=await getAllAvailableStaticRulesets();console.log("CARS: Enabled rulesets: ",JSON.stringify(r)),console.log("CARS: Available static rule count: ",a);let n=o.filter(e=>!r.includes(e))||[];if(console.log("CR: Disabled rulesets: ",JSON.stringify(n)),TARGET_BROWSER!==BROWSER_NAME.Firefox&&n.length>0&&Sentry.captureEvent({message:"Not all rulesets are enabled.",logentry:{message:`Not all rulesets are enabled. Disabled rulesets: ${JSON.stringify(n)}. Available static rule count: ${a}`,params:[n,a]},level:"error",tags:{custom:!0,"bg-source":"ruleset-utils.checkForAdditionalRuleSpace",version:chrome.runtime.getManifest().version}}),s)l||(n=n.filter(e=>!e.includes("malware")));else{const e=["ads","easylist","easyprivacy","arw"];n=n.filter(t=>!e.some(e=>t.includes(e)))}console.debug("CARS: Rulesets to enable: ",{disabledRulesets:n}),await tryUpdateEnabledRulesets(n)};const tryUpdateEnabledRulesets=async e=>{if(0===e.length)return void console.debug("TUER: No rulesets to enable");let t=await chrome.declarativeNetRequest.getAvailableStaticRuleCount();console.debug("TUER: Available rule count: ",t);const s=[];let l=[];for(const r of e)try{await chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:[r]}),s.push(r),console.debug("TUER: Enabled ruleset ",r)}catch(e){console.error("TUER: Error enabling ruleset ",r,chrome.runtime.lastError,e,e.message),l.push({rulesetID:r,isBrowserError:e.message.toLowerCase().includes("internal error")}),TARGET_BROWSER!==BROWSER_NAME.Firefox&&Sentry.captureEvent({message:`Error enabling ruleset ${r}: ${e.message}`,logentry:{message:`Error enabling ruleset ${r}: ${e.message}`,params:[e.message,`Ruleset ID: ${r}`,`Available rule count: ${t}`]},level:"error",tags:{custom:!0,"bg-source":"ruleset-utils.tryUpdateEnabledRulesets",version:chrome.runtime.getManifest().version}})}return{enabledRulesets:s,failedRulesets:l}};export const getRuleStats=async()=>{const e=(await chrome.declarativeNetRequest.getDynamicRules()||[]).length,t=await chrome.declarativeNetRequest.getAvailableStaticRuleCount()||0,s=33e4-t,l=await chrome.declarativeNetRequest.getEnabledRulesets();return{enabledRulesets:l,dynamicRuleCount:e,staticRulesetCount:l.length,staticRuleCount:s,availableStaticRuleCount:t}};export const toggleEnabledRuleset=async(e,t)=>{const s=rulesetsForProtectionConst(e);!1!==t?await tryUpdateEnabledRulesets(s):await chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:t?[]:s})};export const toggleAllEnabledRulesets=async e=>{const t=await chrome.declarativeNetRequest.getEnabledRulesets()||[];console.debug("TAER: Enabled rulesets: ",t);const s=(await getAllAvailableStaticRulesets()||[]).filter(e=>!t.includes(e));console.debug("TAER: Not currently enabled: ",s),!1!==e?await tryUpdateEnabledRulesets(s):await chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:e?[]:t})};function setDifference(e,t){const s=new Set;for(const l of e)t.has(l)||s.add(l);return s}export const disableStaticRules=async e=>{const t=await simpleStorageGet("mv3DisabledRules")||[],s={};for(const e of t)s[e.ruleset]||(s[e.ruleset]=[]),s[e.ruleset].push(e.ruleId);const l={};for(const t of e)l[t.ruleset]||(l[t.ruleset]=[]),l[t.ruleset].push(t.ruleId);for(const e in l){const t=new Set(s[e]||[]),r=new Set(l[e]),a=Array.from(setDifference(t,r)),o=Array.from(r);try{await chrome.declarativeNetRequest.updateStaticRules({disableRuleIds:o,enableRuleIds:a,rulesetId:e}),console.debug("DSR: Disabled rules: ",{ruleset:e,ruleIds:o,existingDisabledIdsToEnable:a})}catch(t){const s=chrome.runtime.lastError;console.error("DSR: Error disabling rules: ",{ruleset:e,ruleIds:o,err:t,runtimeError:s})}}await simpleStorageSet({mv3DisabledRules:e})};const showRulesetErrorPage=async(e,t=!1)=>{let s=TARGET_BROWSER===BROWSER_NAME.Firefox?"moz-extension://":"chrome-extension://";const l=e.map(e=>e.replace("mbgc.mv3.","")).join(","),r=s+chrome.i18n.getMessage("@@extension_id")+`/app/eventpages/ruleset-error.html?disabledRulesets=${l}&isBrowserError=${t}`;console.debug("RULESET: Ruleset error page url: ",r),await isRulesetErrorPageOpen()||chrome.tabs.create({url:r,active:!0},e=>{console.debug("RULESET: Ruleset error page created",e)})},getAllAvailableStaticRulesets=()=>{const e=chrome.runtime.getManifest().declarative_net_request.rule_resources.map(e=>e.id);return console.debug("GASR: All rulesets: ",e),e},rulesetsForProtectionConst=e=>{let t=null;switch(e){case MV3_PROTECTION_ADS:t=["mbgc.mv3.ads","mbgc.mv3.easylist","mbgc.mv3.easyprivacy","mbgc.arw"];break;case MV3_PROTECTION_MALWARE:t=["mbgc.mv3.malware"];break;default:t=[]}const s=getAllAvailableStaticRulesets(),l=[];for(const e of s)t.find(t=>e.startsWith(t))&&l.push(e);return console.debug("RFPC: Affected rulesets: ",{rulesetPatterns:t,protectionConst:e,affected:l}),l},isRulesetErrorPageOpen=async()=>{const e=await chrome.tabs.query({currentWindow:!0});for(const t of e)if(t.url.includes("/ruleset-error.html"))return!0;return!1};